{% extends "base.html" %}
{% block title %}L·ªãch thi ƒë·∫•u{% endblock %}
{% block content %}
<section class="section container" style="padding-top:90px">
  <div style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;margin-bottom:24px">
    <h1 class="section-title" style="margin:0; font-family:var(--font-display); color:white;">Tr·∫≠n ƒê·∫•u ‚Äî <span id="league-label">Premier League</span></h1>
    <div style="display:flex;gap:8px" id="status-tabs">
      <button class="btn btn-primary btn-sm" data-status="" style="font-family:var(--font-display)">T·∫•t c·∫£</button>
      <button class="btn btn-ghost  btn-sm" data-status="SCHEDULED" style="font-family:var(--font-display)">S·∫Øp t·ªõi</button>
      <button class="btn btn-ghost  btn-sm" data-status="LIVE" style="font-family:var(--font-display)">üî¥ Live</button>
      <button class="btn btn-ghost  btn-sm" data-status="FT" style="font-family:var(--font-display)">K·∫øt qu·∫£</button>
    </div>
  </div>

  <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px;">
    <button id="btn-scroll-left" class="btn btn-ghost" style="padding: 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" aria-label="Cu·ªôn tr√°i">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"></polyline></svg>
    </button>

    <div id="gw-bar" style="display:flex;gap:6px;overflow-x:auto;scrollbar-width:none;-webkit-overflow-scrolling:touch;scroll-behavior:smooth;flex-grow:1;padding-bottom:4px"></div>

    <button id="btn-scroll-right" class="btn btn-ghost" style="padding: 0; border-radius: 50%; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;" aria-label="Cu·ªôn ph·∫£i">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="9 18 15 12 9 6"></polyline></svg>
    </button>
  </div>

  <div id="matches-list" style="display:flex;flex-direction:column;gap:8px"></div>
  <div style="text-align:center;margin-top:20px">
    <button id="load-more" class="btn btn-ghost" style="display:none; font-family:var(--font-display); color:white;">Xem th√™m</button>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  let league = "PL", status = "", gw = null, page = 1, totalPages = 1;
  const PER_PAGE = 20;

  function parseUTC(iso) {
    if (!iso) return null;
    let str = iso.replace(" ", "T");
    if (!str.endsWith("Z") && !str.includes("+")) str += "Z";
    return new Date(str);
  }

  function fmtDate(iso) {
    const d = parseUTC(iso);
    if (!d) return "";
    return d.toLocaleDateString("vi-VN", {weekday:"short", day:"2-digit", month:"2-digit", timeZone:"Asia/Ho_Chi_Minh"});
  }

  function fmtTime(iso) {
    const d = parseUTC(iso);
    if (!d) return "";
    return d.toLocaleTimeString("vi-VN", {hour:"2-digit", minute:"2-digit", timeZone:"Asia/Ho_Chi_Minh"});
  }

  function badge(url, name) {
    return `<img src="${url||""}" alt="${(name||"").replace(/"/g,"")}" width="28" height="28"
      style="object-fit:contain;flex-shrink:0" onerror="this.style.opacity=0">`;
  }

  function renderMatch(m) {
    const h = m.home_team || {}, a = m.away_team || {};
    const isLive = m.status === "LIVE", isFT = m.status === "FT";
    const hasScore = h.score != null;
    const UCL_ROUND_LABELS = {9:"Playoff",10:"V√≤ng 1/8",11:"T·ª© k·∫øt",12:"B√°n k·∫øt",13:"Chung k·∫øt"};

    let gwLabel = m.round || "";
    if (league === "UCL" && m.matchweek) {
      gwLabel = UCL_ROUND_LABELS[m.matchweek] || `V√≤ng ${m.matchweek}`;
      if (m.leg) gwLabel += ` ¬∑ L∆∞·ª£t ${m.leg === 1 ? "ƒëi" : "v·ªÅ"}`;
    } else if (m.matchweek) {
      gwLabel = `Tu·∫ßn ${m.matchweek}`;
    }

    let statusHtml;
    if (isLive)
      statusHtml = `<span style="background:var(--color-live);color:#fff;font-size:.7rem;font-weight:800;padding:3px 10px;border-radius:12px;animation:pulse 1s infinite; font-family:var(--font-display);">Live ${m.minute||""}\'</span>`;
    else if (isFT)
      statusHtml = `<span style="background:var(--color-surface-3);color:white;font-size:.7rem;font-weight:700;padding:3px 10px;border-radius:12px; font-family:var(--font-display);">FT</span>`;
    else
      statusHtml = `<span style="font-family:var(--font-display);font-size:.88rem;font-weight:700;color:white;">${fmtTime(m.kickoff_at)}</span>`;

    // S·ª≠a ng∆∞·ª£c t·ªâ s·ªë l∆∞·ª£t v·ªÅ
    let aggHtml = "";
    if (m.agg_home != null && m.agg_away != null && m.leg === 2) {
        aggHtml = `<div style="font-size:.65rem;color:var(--color-text-muted);margin-top:2px">T·ªïng t·ªâ s·ªë: ${m.agg_away} - ${m.agg_home}</div>`;
    }

    const penHtml = (m.home_score_pen != null && m.away_score_pen != null)
      ? `<div style="font-size:.65rem;color:var(--color-accent)">${m.home_score_pen} - ${m.away_score_pen} (lu√¢n l∆∞u)</div>`
      : "";

    const scoreHtml = hasScore
      ? `<div style="font-family:var(--font-display);font-size:1.5rem;font-weight:900;color:${isLive?"var(--color-live)":"white"};display:flex;align-items:center;justify-content:center;gap:8px; line-height:1;">
           <span>${h.score}</span><span style="color:var(--color-text-muted);font-size:1rem">:</span><span>${a.score}</span>
         </div>
         ${h.score_ht!=null?`<div style="font-size:.68rem;color:var(--color-text-muted)">HT ${h.score_ht}:${a.score_ht}</div>`:""}
         ${aggHtml}${penHtml}`
      : `<div style="font-family:var(--font-display);font-size:1.1rem;font-weight:700;color:white;text-align:center; line-height:1;">${fmtDate(m.kickoff_at)}</div>`;

    const events = m.events || [];
    const eventsHtml = (events.length) ? renderEvents(events) : "";
    const hasEvents = events.length > 0;

    return `<div class="card match-card" style="padding:16px 20px;${hasEvents?"cursor:pointer":""}">
      <div style="display:grid; grid-template-columns: 1fr 40px 1fr; align-items:center; margin-bottom:12px; font-size:.75rem;">
        <span style="font-family:var(--font-display); font-weight:700; color:var(--color-text-muted);">${gwLabel}</span>
        <div style="display:flex; justify-content:center;">${statusHtml}</div>
        <div style="display:flex; justify-content:flex-end; font-size:.65rem; color:var(--color-text-dim); font-family:var(--font-display);">
            ${hasEvents ? `‚ñº chi ti·∫øt` : ""}
        </div>
      </div>

      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:16px">
        <div style="display:flex;align-items:center;gap:10px;justify-content:flex-end">
          <span style="font-family:var(--font-display);font-weight:700;font-size:.92rem;text-align:right;color:white;">${(h.name||"").replace(/</g,"&lt;")}</span>
          ${badge(h.badge, h.name)}
        </div>
        <div style="text-align:center;min-width:80px">${scoreHtml}</div>
        <div style="display:flex;align-items:center;gap:10px">
          ${badge(a.badge, a.name)}
          <span style="font-family:var(--font-display);font-weight:700;font-size:.92rem;color:white;">${(a.name||"").replace(/</g,"&lt;")}</span>
        </div>
      </div>

      ${eventsHtml ? `<div class="match-events" style="display:none;margin-top:14px;padding-top:14px;border-top:1px solid var(--color-border)">${eventsHtml}</div>` : ""}
    </div>`;
  }

  function renderEvents(events) {
    const sortedEvents = [...events].sort((a, b) => {
        const minA = parseInt(a.minute.toString().split('+')[0]);
        const minB = parseInt(b.minute.toString().split('+')[0]);
        return minA - minB;
    });

    function evIcon(type) {
      const isUCL = league === "UCL";
      // S·ª≠ d·ª•ng file ·∫£nh n·ªôi b·ªô b·∫°n cung c·∫•p
      const ballUrl = isUCL ? "/static/images/ucl-ball.png" : "/static/images/pl-ball.png";

      const ballHtml = `<img src="${ballUrl}" width="16" height="16"
                             style="vertical-align:middle; object-fit:contain;"
                             onerror="this.outerHTML='‚öΩ'">`;

      if (type === "goal")         return ballHtml;
      if (type === "penalty_goal") return ballHtml;
      if (type === "penalty_miss") return `<span style="filter: grayscale(1); opacity:0.5;">${ballHtml}</span>`;
      if (type === "own_goal")     return `<span style="filter: drop-shadow(0 0 2px #ef4444);">${ballHtml}</span>`;
      if (type === "yellow_card")  return `<span style="display:inline-block;width:10px;height:14px;background:#f5a623;border-radius:2px;"></span>`;
      if (type === "red_card")     return `<span style="display:inline-block;width:10px;height:14px;background:#ef4444;border-radius:2px;"></span>`;
      return "";
    }

    return `<div style="display:flex; flex-direction:column; gap:10px;">
      ${sortedEvents.map(e => {
        const isHome = e.side === "home";
        // C·∫•u tr√∫c 3 c·ªôt: Tr·ª•c gi·ªØa icon lu√¥n th·∫≥ng h√†ng v·ªõi ch·ªØ Kt
        return `
        <div style="display:grid; grid-template-columns: 1fr 40px 1fr; align-items:center; font-size:.82rem; font-family:var(--font-display);">
          <div style="text-align:right; color:white; padding-right:12px;">
            ${isHome ? `<span>${e.player} <span style="color:var(--color-text-muted); font-size:.72rem; margin-left:4px;">${e.minute}'</span></span>` : ""}
          </div>
          <div style="display:flex; justify-content:center; align-items:center;">
            ${evIcon(e.type)}
          </div>
          <div style="text-align:left; color:white; padding-left:12px;">
            ${!isHome ? `<span><span style="color:var(--color-text-muted); font-size:.72rem; margin-right:4px;">${e.minute}'</span> ${e.player}</span>` : ""}
          </div>
        </div>`;
      }).join("")}
    </div>`;
  }

  async function loadGWBar() {
    const res = await fetch(`/api/matches/rounds?league=${league}&season=2025`);
    if (!res.ok) return;
    const data = await res.json();
    const rounds = data.rounds || [];
    const bar = document.getElementById("gw-bar");

    let currentGW = null;
    const currentRound = rounds.find(r => r.is_current);
    if (currentRound) {
      currentGW = currentRound.matchweek;
    } else {
      try {
        const nextRes = await fetch(`/api/matches/?league=${league}&season=2025&status=SCHEDULED&per_page=1`);
        const nextData = await nextRes.json();
        if (nextData.items && nextData.items.length > 0) {
          currentGW = nextData.items[0].matchweek;
        } else if (rounds.length > 0) {
          currentGW = rounds[rounds.length - 1].matchweek;
        }
      } catch (e) { console.error(e); }
    }

    gw = currentGW;
    bar.innerHTML = `<button class="btn ${!gw ? 'btn-primary' : 'btn-ghost'} btn-sm" data-gw="" style="font-family:var(--font-display)">T·∫•t c·∫£</button>` +
      rounds.map(r => {
        const btnClass = r.matchweek == gw ? "btn-primary" : "btn-ghost";
        const labelText = (r.label || "").replace(/GW/g, "Tu·∫ßn");
        return `<button class="btn ${btnClass} btn-sm" data-gw="${r.matchweek}" style="font-family:var(--font-display)">${labelText}</button>`;
      }).join("");

    setTimeout(() => {
      const targetBtn = bar.querySelector(`[data-gw="${gw || ''}"]`);
      if (targetBtn) targetBtn.scrollIntoView({ inline: "center", behavior: "smooth" });
    }, 150);

    bar.onclick = e => {
      const btn = e.target.closest("[data-gw]");
      if (!btn) return;
      gw = btn.dataset.gw ? parseInt(btn.dataset.gw) : null;
      page = 1;
      bar.querySelectorAll("[data-gw]").forEach(b => {
        b.classList.remove("btn-primary");
        b.classList.add("btn-ghost");
      });
      btn.classList.add("btn-primary");
      btn.classList.remove("btn-ghost");
      loadMatches(false);
    };

    loadMatches(false);
  }

  async function loadMatches(append) {
    const list = document.getElementById("matches-list");
    if (!append) list.innerHTML = Array(5).fill('<div class="skeleton" style="height:100px;border-radius:12px"></div>').join("");

    let url = `/api/matches/?league=${league}&season=2025&per_page=${PER_PAGE}&page=${page}`;
    if (status) url += `&status=${status}`;
    if (gw)     url += `&matchweek=${gw}`;

    let res, data;
    try {
      res = await fetch(url);
      data = await res.json();
    } catch(e) {
      list.innerHTML = `<div class="card" style="padding:32px;text-align:center;color:white">L·ªói k·∫øt n·ªëi.</div>`;
      return;
    }

    const items = data.items || [];
    totalPages = data.pages || 1;
    const html = items.map(renderMatch).join("") ||
      `<div class="card" style="padding:32px;text-align:center;color:white">Kh√¥ng c√≥ tr·∫≠n ƒë·∫•u.</div>`;

    if (append) list.insertAdjacentHTML("beforeend", html);
    else list.innerHTML = html;

    document.getElementById("load-more").style.display = page < totalPages ? "" : "none";
  }

  function setLeague(lg) {
    league = (lg || "PL").toUpperCase();
    document.getElementById("league-label").textContent = league === "UCL" ? "Champions League" : "Premier League";
    status = ""; gw = null; page = 1;

    document.querySelectorAll("[data-status]").forEach(b => {
      b.classList.remove("btn-primary");
      b.classList.add("btn-ghost");
    });
    const allStatusBtn = document.querySelector("[data-status='']");
    if (allStatusBtn) {
      allStatusBtn.classList.add("btn-primary");
      allStatusBtn.classList.remove("btn-ghost");
    }
    loadGWBar();
  }

  document.addEventListener("DOMContentLoaded", () => {
    setLeague(typeof Theme !== "undefined" ? Theme.getLeague() : "PL");
    if (typeof Theme !== "undefined") Theme.onChange(setLeague);

    document.getElementById("matches-list").addEventListener("click", e => {
      const card = e.target.closest(".match-card");
      if (!card) return;
      const panel = card.querySelector(".match-events");
      if (!panel) return;
      panel.style.display = panel.style.display === "none" ? "block" : "none";
      const arrowEl = card.querySelector("span[style*='‚ñº'], span[style*='‚ñ≤']");
      if (arrowEl) arrowEl.textContent = panel.style.display === "none" ? "‚ñº chi ti·∫øt" : "‚ñ≤ ·∫©n";
    });

    document.getElementById("status-tabs").addEventListener("click", e => {
      const btn = e.target.closest("[data-status]");
      if (!btn) return;
      status = btn.dataset.status;
      page = 1;
      document.querySelectorAll("[data-status]").forEach(b => {
        b.classList.remove("btn-primary");
        b.classList.add("btn-ghost");
      });
      btn.classList.add("btn-primary");
      btn.classList.remove("btn-ghost");
      loadMatches(false);
    });

    document.getElementById("load-more").addEventListener("click", () => { page++; loadMatches(true); });

    document.getElementById("btn-scroll-left")?.addEventListener("click", () => {
      const buttons = Array.from(document.getElementById("gw-bar").querySelectorAll("button[data-gw]"));
      const currentIndex = buttons.findIndex(b => b.classList.contains("btn-primary"));
      if (currentIndex > 0) {
        buttons[currentIndex - 1].click();
        buttons[currentIndex - 1].scrollIntoView({ inline: "center", behavior: "smooth", block: "nearest" });
      }
    });

    document.getElementById("btn-scroll-right")?.addEventListener("click", () => {
      const buttons = Array.from(document.getElementById("gw-bar").querySelectorAll("button[data-gw]"));
      const currentIndex = buttons.findIndex(b => b.classList.contains("btn-primary"));
      if (currentIndex !== -1 && currentIndex < buttons.length - 1) {
        buttons[currentIndex + 1].click();
        buttons[currentIndex + 1].scrollIntoView({ inline: "center", behavior: "smooth", block: "nearest" });
      }
    });

    setInterval(() => { if (status === "LIVE") loadMatches(false); }, 30000);
  });
})();
</script>
{% endblock %}