{% extends "base.html" %}
{% block title %}Trang Cá Nhân{% endblock %}
{% block content %}
<div style="padding-top:var(--header-height);min-height:100vh; background:var(--color-surface-1);">

  <div style="background:linear-gradient(135deg,var(--color-primary-dark) 0%,var(--color-primary) 100%);padding:48px 0 56px">
    <div class="container" style="display:flex;align-items:center;gap:28px">
      <div style="position:relative;flex-shrink:0">
        <div id="avatar-ring" style="width:96px;height:96px;border-radius:50%;background:var(--color-surface-3);border:4px solid var(--color-accent);position:relative;cursor:pointer; box-sizing:border-box; display:flex; align-items:center; justify-content:center; overflow:hidden;" onclick="document.getElementById('avatar-modal').style.display='flex'">
          <img id="avatar-img" src="" alt="" style="width:100%;height:100%;object-fit:cover;position:absolute;inset:0;z-index:1;display:none;">
          <span id="avatar-initials" style="font-family:var(--font-display);font-size:2.4rem;font-weight:900;color:var(--color-accent);line-height:1;z-index:0;display:flex;align-items:center;justify-content:center;width:100%;height:100%;">?</span>
          <div style="position:absolute;inset:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;opacity:0;transition:opacity 0.2s;z-index:2;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
          </div>
        </div>
      </div>
      <div style="padding-bottom:48px">
        <div id="hero-username" style="font-family:var(--font-display);font-size:.75rem;font-weight:700;letter-spacing:.12em;text-transform:uppercase;color:var(--color-accent);margin-bottom:4px"></div>
        <div id="hero-name" style="font-family:var(--font-display);font-size:clamp(1.4rem,3vw,2.2rem);font-weight:900;color:white;line-height:1.1"></div>
        </div>
    </div>
  </div>

  <div id="avatar-modal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.8);z-index:9999;align-items:center;justify-content:center;padding:20px">
    <div class="card" style="width:100%;max-width:400px;padding:24px;position:relative; background:var(--color-surface-2); border:1px solid var(--color-border);">
      <button onclick="document.getElementById('avatar-modal').style.display='none'" style="position:absolute;top:16px;right:16px;background:none;border:none;color:white;cursor:pointer;font-size:1.2rem">✕</button>
      <h3 style="font-family:var(--font-display);font-weight:900;font-size:1.1rem;margin-top:0;margin-bottom:16px;color:white; text-transform:uppercase;">Đổi ảnh đại diện</h3>

      <div style="margin-bottom:20px">
        <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:8px;font-family:var(--font-display);text-transform:uppercase;">Tải ảnh từ máy tính</label>
        <label for="inp-avatar-file" class="btn btn-ghost w-full" style="justify-content:center;cursor:pointer;gap:8px; border:1px solid var(--color-border); padding:10px;">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>
          Chọn tệp...
        </label>
        <input id="inp-avatar-file" type="file" accept="image/*" style="display:none" onchange="previewAvatarFile(this)">
      </div>

      <div style="text-align:center;color:var(--color-text-dim);font-size:.8rem;margin:16px 0">- hoặc -</div>

      <div style="margin-bottom:24px">
        <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:8px;font-family:var(--font-display);text-transform:uppercase;">Nhập đường dẫn ảnh (URL)</label>
        <input id="inp-avatar-url" type="text" placeholder="https://example.com/image.jpg" style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-3);color:white;font-size:.88rem;font-family:var(--font-display);box-sizing:border-box" oninput="previewAvatarUrl(this)">
      </div>

      <div id="avatar-preview-container" style="display:none;margin-bottom:24px;text-align:center">
        <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:8px;font-family:var(--font-display);text-transform:uppercase;">Xem trước</label>
        <img id="avatar-preview-img" src="" alt="Preview" style="width:80px;height:80px;border-radius:50%;object-fit:cover;border:2px solid var(--color-accent);margin:0 auto; display:block;">
      </div>

      <div style="display:flex;justify-content:flex-end;gap:12px">
        <button class="btn btn-ghost" onclick="document.getElementById('avatar-modal').style.display='none'">Hủy</button>
        <button class="btn btn-primary" onclick="saveAvatar()">Lưu thay đổi</button>
      </div>
    </div>
  </div>

  <div class="section container" style="padding-top:52px">
    <div id="not-logged" style="display:none;text-align:center;padding:60px 0">
      <p style="color:var(--color-text-muted);font-size:.95rem">Bạn chưa đăng nhập.</p>
      <a href="/login" class="btn btn-primary" style="margin-top:16px;display:inline-block">Đăng nhập</a>
    </div>

    <div id="profile-content" style="display:none;display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:860px">

      <div class="card" style="padding:0;overflow:hidden;grid-column:1/-1; background:var(--color-surface-2); border:1px solid var(--color-border);">
        <div style="padding:14px 20px;background:var(--color-surface-2);border-bottom:1px solid var(--color-border)">
          <h3 style="font-family:var(--font-display);font-weight:900;font-size:.82rem;text-transform:uppercase;letter-spacing:.08em;color:var(--color-accent);margin:0">Thông tin tài khoản</h3>
        </div>
        <div style="padding:20px;display:grid;grid-template-columns:1fr 1fr;gap:16px">
          <div style="grid-column:1/-1">
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Họ tên</label>
            <input id="inp-fullname" type="text" placeholder="Họ và tên..."
              style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-3);color:white;font-size:.88rem;font-family:var(--font-display);box-sizing:border-box">
          </div>
          <div>
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Username</label>
            <input id="inp-username" type="text" disabled
              style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-2);color:var(--color-text-muted);font-size:.88rem;font-family:var(--font-display);box-sizing:border-box;cursor:not-allowed">
          </div>
          <div>
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Email</label>
            <input id="inp-email" type="text" disabled
              style="width:100%;padding:10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-2);color:var(--color-text-muted);font-size:.88rem;font-family:var(--font-display);box-sizing:border-box;cursor:not-allowed">
          </div>

          <div style="grid-column:1/-1;display:flex;align-items:center;gap:12px; margin-top:8px">
            <button onclick="saveProfile()" class="btn btn-primary" style="font-family:var(--font-display);font-weight:800; text-transform:uppercase; padding:12px 24px;">Lưu thay đổi</button>
            <span id="save-msg" style="font-size:.8rem;color:var(--color-accent);display:none"></span>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden; background:var(--color-surface-2); border:1px solid var(--color-border);">
        <div style="padding:14px 20px;background:var(--color-surface-2);border-bottom:1px solid var(--color-border)">
          <h3 style="font-family:var(--font-display);font-weight:900;font-size:.82rem;text-transform:uppercase;letter-spacing:.08em;color:var(--color-accent);margin:0">Đổi mật khẩu</h3>
        </div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
          <div style="position:relative">
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Mật khẩu hiện tại</label>
            <input id="inp-curpw" type="password" placeholder="••••••••"
              style="width:100%;padding:10px 40px 10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-3);color:white;font-size:.88rem;font-family:var(--font-display);box-sizing:border-box">
            <button type="button" onclick="togglePassword('inp-curpw', this)" style="position:absolute;right:10px;top:26px;background:none;border:none;padding:0;color:var(--color-text-muted);cursor:pointer;width:24px;height:24px;display:flex;align-items:center;justify-content:center; filter: grayscale(1);">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div style="position:relative">
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Mật khẩu mới</label>
            <input id="inp-newpw" type="password" placeholder="••••••••"
              style="width:100%;padding:10px 40px 10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-3);color:white;font-size:.88rem;font-family:var(--font-display);box-sizing:border-box">
             <button type="button" onclick="togglePassword('inp-newpw', this)" style="position:absolute;right:10px;top:26px;background:none;border:none;padding:0;color:var(--color-text-muted);cursor:pointer;width:24px;height:24px;display:flex;align-items:center;justify-content:center; filter: grayscale(1);">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div style="position:relative">
            <label style="font-size:.72rem;color:var(--color-text-muted);display:block;margin-bottom:5px;font-family:var(--font-display);text-transform:uppercase;letter-spacing:.06em">Xác nhận mật khẩu mới</label>
            <input id="inp-confirmpw" type="password" placeholder="••••••••"
              style="width:100%;padding:10px 40px 10px 14px;border-radius:10px;border:1px solid var(--color-border);background:var(--color-surface-3);color:white;font-size:.88rem;font-family:var(--font-display);box-sizing:border-box">
            <button type="button" onclick="togglePassword('inp-confirmpw', this)" style="position:absolute;right:10px;top:26px;background:none;border:none;padding:0;color:var(--color-text-muted);cursor:pointer;width:24px;height:24px;display:flex;align-items:center;justify-content:center; filter: grayscale(1);">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            </button>
          </div>
          <div style="display:flex;align-items:center;gap:12px;margin-top:10px">
            <button onclick="changePassword()" class="btn btn-primary" style="font-family:var(--font-display);font-weight:800; text-transform:uppercase; padding:12px 24px;">Đổi mật khẩu</button>
            <span id="pw-msg" style="font-size:.8rem;display:none"></span>
          </div>
        </div>
      </div>

      <div class="card" style="padding:0;overflow:hidden; background:var(--color-surface-2); border:1px solid var(--color-border);">
        <div style="padding:14px 20px;background:var(--color-surface-2);border-bottom:1px solid var(--color-border)">
          <h3 style="font-family:var(--font-display);font-weight:900;font-size:.82rem;text-transform:uppercase;letter-spacing:.08em;color:var(--color-accent);margin:0">Thống kê</h3>
        </div>
        <div style="padding:20px;display:flex;flex-direction:column;gap:14px">
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--color-border)">
            <span style="font-size:.82rem;color:var(--color-text-muted)">Ngày tham gia</span>
            <span id="stat-joined" style="font-family:var(--font-display);font-weight:700;font-size:.85rem; color:white"></span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0;border-bottom:1px solid var(--color-border)">
            <span style="font-size:.82rem;color:var(--color-text-muted)">Đăng nhập lần cuối</span>
            <span id="stat-lastlogin" style="font-family:var(--font-display);font-weight:700;font-size:.85rem; color:white"></span>
          </div>
          <div style="display:flex;justify-content:space-between;align-items:center;padding:10px 0">
            <span style="font-size:.82rem;color:var(--color-text-muted)">Quyền truy cập</span>
            <span id="stat-role" style="font-family:var(--font-display);font-weight:700;font-size:.85rem; color:white"></span>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  let user = null;

  function fmtDate(iso) {
    if (!iso) return "—";
    return new Date(iso).toLocaleDateString("vi-VN", {
      day:"2-digit", month:"2-digit", year:"numeric",
      hour:"2-digit", minute:"2-digit", timeZone:"Asia/Ho_Chi_Minh"
    });
  }

  function initials(name, username) {
    const n = name || username || "?";
    return n.split(" ").map(w => w[0]).join("").toUpperCase().slice(0,2);
  }

  function fillPage(u) {
    user = u;

    // Hero
    document.getElementById("hero-username").textContent = "@" + u.username;
    document.getElementById("hero-name").textContent = u.full_name || u.username;

    // Avatar
    if (u.avatar_url) {
      const img = document.getElementById("avatar-img");
      img.src = u.avatar_url;
      img.style.display = "";
      document.getElementById("avatar-initials").style.display = "none";
      document.getElementById("inp-avatar-url").value = u.avatar_url;
    } else {
      document.getElementById("avatar-initials").textContent = initials(u.full_name, u.username);
      document.getElementById("avatar-img").style.display = "none";
      document.getElementById("avatar-initials").style.display = "flex";
      document.getElementById("inp-avatar-url").value = "";
    }

    // Inputs
    document.getElementById("inp-fullname").value = u.full_name || "";
    document.getElementById("inp-username").value = u.username;
    document.getElementById("inp-email").value    = u.email;

    // Stats
    document.getElementById("stat-joined").textContent    = fmtDate(u.created_at);
    document.getElementById("stat-lastlogin").textContent = fmtDate(u.last_login);
    document.getElementById("stat-role").textContent      = u.is_admin ? "Admin" : "Thành viên";

    document.getElementById("profile-content").style.display = "grid";
  }

  // Cập nhật hàm save chỉ gửi full_name
  async function saveProfile() {
    const full_name = document.getElementById("inp-fullname").value.trim();
    const msg = document.getElementById("save-msg");

    const res = await fetch("/api/auth/me", {
      method: "PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({full_name})
    });
    const data = await res.json();
    msg.style.display = "";
    if (data.success) {
      msg.style.color = "var(--color-accent)";
      msg.textContent = "Đã lưu!";
      fillPage(data.user);
    } else {
      msg.style.color = "#e74c3c";
      msg.textContent = data.error || "Lỗi!";
    }
    setTimeout(() => msg.style.display = "none", 3000);
  }

  async function saveAvatar() {
    const avatar_url = document.getElementById("inp-avatar-url").value.trim();
    const res = await fetch("/api/auth/me", {
      method: "PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({ avatar_url })
    });
    const data = await res.json();

    if (data.success) {
      fillPage(data.user);
      document.getElementById('avatar-modal').style.display='none';
      document.getElementById('inp-avatar-file').value = "";
      document.getElementById('avatar-preview-container').style.display='none';
      if (typeof Auth !== 'undefined' && Auth.updateHeaderUI) Auth.updateHeaderUI(data.user);
    } else {
      alert("Lỗi cập nhật ảnh đại diện: " + (data.error || "Không xác định"));
    }
  }

  function previewAvatarFile(input) {
    const previewContainer = document.getElementById("avatar-preview-container");
    const previewImg = document.getElementById("avatar-preview-img");
    const urlInput = document.getElementById("inp-avatar-url");

    if (input.files && input.files[0]) {
      const reader = new FileReader();
      reader.onload = function(e) {
        previewImg.src = e.target.result;
        previewContainer.style.display = "block";
        urlInput.value = e.target.result;
      }
      reader.readAsDataURL(input.files[0]);
    } else {
      previewContainer.style.display = "none";
      urlInput.value = user.avatar_url || "";
    }
  }

  function previewAvatarUrl(input) {
    const previewContainer = document.getElementById("avatar-preview-container");
    const previewImg = document.getElementById("avatar-preview-img");
    const fileInput = document.getElementById("inp-avatar-file");
    const url = input.value.trim();

    if (url && !url.startsWith("data:")) {
      previewImg.src = url;
      previewContainer.style.display = "block";
      fileInput.value = "";
    } else if (!url) {
      previewContainer.style.display = "none";
    }
  }

  async function changePassword() {
    const current_password = document.getElementById("inp-curpw").value;
    const new_password     = document.getElementById("inp-newpw").value;
    const confirm          = document.getElementById("inp-confirmpw").value;
    const msg = document.getElementById("pw-msg");

    msg.style.display = "";
    if (!current_password || !new_password) {
      msg.style.color = "#e74c3c";
      msg.textContent = "Vui lòng điền đầy đủ.";
      return;
    }
    if (new_password !== confirm) {
      msg.style.color = "#e74c3c";
      msg.textContent = "Mật khẩu xác nhận không khớp.";
      return;
    }

    const res = await fetch("/api/auth/me", {
      method: "PATCH",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({current_password, new_password})
    });
    const data = await res.json();
    if (data.success) {
      msg.style.color = "var(--color-accent)";
      msg.textContent = "Đổi mật khẩu thành công!";
      document.getElementById("inp-curpw").value = "";
      document.getElementById("inp-newpw").value = "";
      document.getElementById("inp-confirmpw").value = "";
    } else {
      msg.style.color = "#e74c3c";
      msg.textContent = data.error || "Lỗi!";
    }
    setTimeout(() => msg.style.display = "none", 3000);
  }

  function togglePassword(inputId, button) {
    const input = document.getElementById(inputId);
    const openSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>';
    const closeSvg = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><path d="M10 12h4"/></svg>';

    if (input.type === "password") {
      input.type = "text";
      button.innerHTML = closeSvg;
    } else {
      input.type = "password";
      button.innerHTML = openSvg;
    }
  }

  window.saveProfile      = saveProfile;
  window.saveAvatar       = saveAvatar;
  window.previewAvatarFile = previewAvatarFile;
  window.previewAvatarUrl  = previewAvatarUrl;
  window.changePassword   = changePassword;
  window.togglePassword   = togglePassword;

  document.addEventListener("DOMContentLoaded", async () => {
    const res = await fetch("/api/auth/me");
    const data = await res.json();
    if (!data.success || !data.user) {
      document.getElementById("not-logged").style.display = "block";
      return;
    }
    fillPage(data.user);
  });
})();
</script>
{% endblock %}