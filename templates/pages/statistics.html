{% extends "base.html" %}
{% block title %}Thống kê{% endblock %}
{% block content %}
<section class="section container" style="padding-top:90px">
  <h1 class="section-title">Thống Kê — <span id="league-label">Premier League</span></h1>

  <div style="display:flex;gap:8px;flex-wrap:wrap;margin-bottom:24px" id="stat-tabs">
    <button class="btn btn-primary btn-sm" data-stat="goals"       data-label="Bàn thắng">Ghi bàn</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="assists"     data-label="Kiến tạo">Kiến tạo</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="appearances" data-label="Trận ra sân">Ra sân</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="clean_sheets" data-label="Giữ sạch lưới" data-pos="GK">Giữ sạch lưới</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="red_cards"   data-label="Thẻ đỏ">Thẻ đỏ</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="yellow_cards" data-label="Thẻ vàng">Thẻ vàng</button>
    <button class="btn btn-ghost  btn-sm"  data-stat="average_rating" data-label="Điểm số">Điểm số</button>
  </div>

  <div class="card" style="overflow-x:auto">
    <table class="standings-table">
      <thead>
        <tr>
          <th style="width:40px">#</th>
          <th style="text-align:left;min-width:180px">Cầu thủ</th>
          <th style="min-width:120px">CLB</th>
          <th style="width:110px">Vị trí</th>
          <th id="stat-header" style="color:var(--color-accent);width:100px">Bàn thắng</th>
        </tr>
      </thead>
      <tbody id="stat-body">
        <tr><td colspan="5" style="text-align:center;padding:40px;color:var(--color-text-muted)">Đang tải...</td></tr>
      </tbody>
    </table>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  const POS_LABEL = {GK:"Thủ môn", DEF:"Hậu vệ", MID:"Tiền vệ", FWD:"Tiền đạo"};
  let currentStat = "goals", currentLeague = "PL", currentPos = "";

  function setLeague(lg) {
    currentLeague = (lg||"PL").toUpperCase();
    document.getElementById("league-label").textContent =
      currentLeague === "UCL" ? "Champions League" : "Premier League";
  }

  async function loadStats() {
  const tbody = document.getElementById("stat-body");
  // Skeleton loading
  tbody.innerHTML = Array(10).fill('<tr><td colspan="5"><div class="skeleton" style="height:38px;margin:4px 0"></div></td></tr>').join("");

  let url = `/api/statistics/players?league=${currentLeague}&sort=${currentStat}&per_page=50`;
  if (currentPos) url += `&position=${currentPos}`;

  let res, data;
  try {
    res  = await fetch(url);
    data = await res.json();
  } catch(e) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--color-text-muted)">Lỗi kết nối.</td></tr>`;
    return;
  }

  // Cập nhật tiêu đề cột dựa trên loại thống kê đang chọn
  document.getElementById("stat-header").textContent =
    document.querySelector(`[data-stat="${currentStat}"]`)?.dataset.label || currentStat;

  const items = data.items || [];
  if (!items.length) {
    tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;padding:32px;color:var(--color-text-muted)">Chưa có dữ liệu.</td></tr>`;
    return;
  }

  tbody.innerHTML = items.map((s, i) => {
    const val = s[currentStat];
    const display = currentStat === "average_rating"
      ? (val != null ? parseFloat(val).toFixed(2) : "—")
      : (val != null ? val : 0);

    return `<tr>
      <td style="font-family:var(--font-display);font-weight:900;color:var(--color-text-muted)">${i+1}</td>
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <img src="${s.player_photo||""}" width="34" height="34"
               style="border-radius:50%;object-fit:cover;background:var(--color-surface-3);flex-shrink:0"
               onerror="this.style.opacity=0">
          <a href="/players/${s.player_id}"
             style="font-family:var(--font-display);font-weight:700;font-size:.88rem"
             onmouseover="this.style.color='var(--color-accent)'" onmouseout="this.style.color=''">
            ${(s.player_name||"").replace(/</g,"&lt;")}
          </a>
        </div>
      </td>
      <td style="font-size:.8rem;color:var(--color-text-muted)">${(s.club_name||"").replace(/</g,"&lt;")}</td>

      <td>
        <span class="badge" style="background:var(--color-surface-3); font-size:.7rem; display:inline-block; width:80px; text-align:center; padding:4px 0; white-space:nowrap; border-radius:12px;">
          ${POS_LABEL[s.player_position] || s.player_position || "—"}
        </span>
      </td>

      <td style="font-family:var(--font-display);font-weight:900;font-size:1.1rem;color:var(--color-accent)">${display}</td>
    </tr>`;
  }).join("");
}

  document.addEventListener("DOMContentLoaded", () => {
    setLeague(typeof Theme !== "undefined" ? Theme.getLeague() : "PL");
    loadStats();
    if (typeof Theme !== "undefined") Theme.onChange(lg => { setLeague(lg); loadStats(); });

    document.getElementById("stat-tabs").addEventListener("click", e => {
      const btn = e.target.closest("[data-stat]"); if (!btn) return;
      currentStat = btn.dataset.stat;
      currentPos  = btn.dataset.pos || "";
      document.querySelectorAll("[data-stat]").forEach(b => { b.classList.remove("btn-primary"); b.classList.add("btn-ghost"); });
      btn.classList.add("btn-primary"); btn.classList.remove("btn-ghost");
      loadStats();
    });
  });
})();
</script>
{% endblock %}