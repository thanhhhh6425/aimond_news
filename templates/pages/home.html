{% extends "base.html" %}
{% block title %}Aimond News{% endblock %}

{% block content %}
<!-- HERO -->
<section class="hero">
  <div class="hero-bg"></div>
  <div class="hero-bg-pattern"></div>
  <div class="hero-bg-gradient"></div>
  <div class="container hero-content">
    <p class="hero-eyebrow"><span data-league-label>Premier League</span> ¬∑ M√πa <span data-league-season>2025/26</span></p>
    <h1 class="hero-title">Tin T·ª©c<br><em>B√≥ng ƒê√°</em></h1>
    <p style="color:rgba(255,255,255,.7);max-width:480px;margin-bottom:24px;font-size:.95rem">
      C·∫≠p nh·∫≠t real-time t·ª´ premierleague.com & uefa.com. S·ªë li·ªáu ch√≠nh x√°c tuy·ªát ƒë·ªëi.
    </p>
    <div style="display:flex;gap:12px;flex-wrap:wrap">
      <a href="/matches" class="btn btn-primary btn-lg">Xem L·ªãch ƒê·∫•u</a>
      <a href="/table"   class="btn btn-ghost  btn-lg">B·∫£ng X·∫øp H·∫°ng</a>
    </div>
  </div>
</section>

<!-- LIVE MATCHES BAR -->
<div id="live-bar" class="container" style="margin-top:24px;display:none">
  <div style="background:rgba(233,0,82,.12);border:1px solid rgba(233,0,82,.3);border-radius:var(--radius-lg);padding:14px 20px;display:flex;align-items:center;gap:14px;flex-wrap:wrap">
    <span style="display:flex;align-items:center;gap:7px;font-family:var(--font-display);font-weight:800;font-size:.85rem;color:var(--color-live);letter-spacing:.06em;text-transform:uppercase;flex-shrink:0">
      <span style="width:8px;height:8px;border-radius:50%;background:var(--color-live);animation:pulse-live 1.2s ease infinite"></span>LIVE
    </span>
    <div id="live-matches-inline" style="display:flex;gap:16px;flex-wrap:wrap;flex:1"></div>
    <a href="/matches" class="btn btn-sm" style="background:var(--color-live);color:#fff;flex-shrink:0">Xem t·∫•t c·∫£</a>
  </div>
</div>

<!-- NEWS FEED -->
<section class="section container">
  <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:28px;flex-wrap:wrap;gap:12px">
    <h2 class="section-title" style="margin-bottom:0"><span data-league-label>Premier League</span> ‚Äî Tin T·ª©c</h2>
    <div style="display:flex;gap:8px" id="news-filters">
      <button class="btn btn-sm btn-primary" data-cat="">T·∫•t c·∫£</button>
      <button class="btn btn-sm btn-ghost"   data-cat="Match Report">Tr·∫≠n ƒë·∫•u</button>
      <button class="btn btn-sm btn-ghost"   data-cat="Transfer">Chuy·ªÉn nh∆∞·ª£ng</button>
      <button class="btn btn-sm btn-ghost"   data-cat="Interview">Ph·ªèng v·∫•n</button>
    </div>
  </div>
  <div id="news-grid" class="grid-news">
    <div class="card" style="padding:20px"><div class="skeleton" style="height:140px;margin-bottom:12px"></div><div class="skeleton" style="height:16px;margin-bottom:8px"></div><div class="skeleton" style="height:16px;width:70%"></div></div>
    <div class="card" style="padding:20px"><div class="skeleton" style="height:140px;margin-bottom:12px"></div><div class="skeleton" style="height:16px;margin-bottom:8px"></div><div class="skeleton" style="height:16px;width:70%"></div></div>
    <div class="card" style="padding:20px"><div class="skeleton" style="height:140px;margin-bottom:12px"></div><div class="skeleton" style="height:16px;margin-bottom:8px"></div><div class="skeleton" style="height:16px;width:70%"></div></div>
  </div>
  <div style="text-align:center;margin-top:32px">
    <button id="load-more-news" class="btn btn-ghost">Xem th√™m tin t·ª©c</button>
  </div>
</section>

<!-- QUICK STATS ROW -->
<section class="section container" style="padding-top:0">
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:24px">

    <!-- Upcoming Matches -->
    <div class="card" style="padding:24px">
      <h3 class="section-title" style="font-size:1.1rem;margin-bottom:20px">Tr·∫≠n S·∫Øp T·ªõi</h3>
      <div id="upcoming-list" style="display:flex;flex-direction:column;gap:12px">
        <div class="skeleton" style="height:60px"></div>
        <div class="skeleton" style="height:60px"></div>
        <div class="skeleton" style="height:60px"></div>
      </div>
      <a href="/matches" class="btn btn-ghost w-full mt-md" style="justify-content:center">Xem l·ªãch ƒë·∫ßy ƒë·ªß</a>
    </div>

    <!-- Mini Table -->
    <div class="card" style="padding:24px">
      <h3 class="section-title" style="font-size:1.1rem;margin-bottom:20px">B·∫£ng XH ‚Äî Top 5</h3>
      <div id="mini-table">
        <div class="skeleton" style="height:32px;margin-bottom:6px"></div>
        <div class="skeleton" style="height:32px;margin-bottom:6px"></div>
        <div class="skeleton" style="height:32px;margin-bottom:6px"></div>
        <div class="skeleton" style="height:32px;margin-bottom:6px"></div>
        <div class="skeleton" style="height:32px"></div>
      </div>
      <a href="/table" class="btn btn-ghost w-full mt-md" style="justify-content:center">B·∫£ng XH ƒë·∫ßy ƒë·ªß</a>
    </div>

  </div>
</section>

<!-- TOP SCORERS STRIP -->
<section class="section container" style="padding-top:0">
  <div class="card" style="padding:24px">
    <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;flex-wrap:wrap;gap:8px">
      <h3 class="section-title" style="font-size:1.1rem;margin-bottom:0">‚öΩ Vua Ph√° L∆∞·ªõi</h3>
      <a href="/statistics?sort=goals" class="btn btn-sm btn-ghost">Xem t·∫•t c·∫£</a>
    </div>
    <div id="top-scorers" style="display:grid;grid-template-columns:repeat(5,1fr);gap:12px;text-align:center">
      {% for i in range(5) %}
      <div><div class="skeleton" style="width:56px;height:56px;border-radius:50%;margin:0 auto 8px"></div><div class="skeleton" style="height:14px;margin-bottom:4px"></div><div class="skeleton" style="height:12px;width:60%;margin:0 auto"></div></div>
      {% endfor %}
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
const PageData = (() => {
  let newsPage = 1, newsCat = "", loading = false;

  async function reload(league) {
    newsPage = 1; newsCat = "";
    await Promise.all([loadNews(), loadLive(), loadUpcoming(), loadMiniTable(), loadTopScorers()]);
  }

  async function loadNews(append=false) {
    const grid = document.getElementById("news-grid");
    if (!append) grid.innerHTML = [1,2,3].map(()=>`<div class="card" style="padding:20px"><div class="skeleton" style="height:140px;margin-bottom:12px"></div><div class="skeleton" style="height:16px;margin-bottom:8px"></div><div class="skeleton" style="height:16px;width:70%"></div></div>`).join("");

    const league = typeof Theme !== "undefined" ? Theme.getLeague() : "PL";
    let url = `/api/news/?league=${league}&per_page=3&page=${newsPage}`;
    if (newsCat) url += `&category=${encodeURIComponent(newsCat)}`;

    let res, data;
    try { res = await fetch(url); data = await res.json(); }
    catch(e) { grid.innerHTML = `<p style="color:var(--color-text-muted);text-align:center;padding:20px">L·ªói t·∫£i tin t·ª©c.</p>`; return; }

    const items = data.items || [];

    function timeAgo(iso) {
      if (!iso) return "";
      const diff = (Date.now() - new Date(iso)) / 1000;
      if (diff < 3600)   return Math.floor(diff/60) + " ph√∫t tr∆∞·ªõc";
      if (diff < 86400)  return Math.floor(diff/3600) + " gi·ªù tr∆∞·ªõc";
      return Math.floor(diff/86400) + " ng√†y tr∆∞·ªõc";
    }

    const html = items.map(n => `
      <article class="card news-card" onclick="window.open('${n.source_url||'#'}','_blank')" style="cursor:pointer;overflow:hidden;transition:transform .2s" onmouseover="this.style.transform='translateY(-3px)'" onmouseout="this.style.transform=''">
        <div style="height:160px;overflow:hidden;background:var(--color-surface-2)">
          <img src="${n.thumbnail_url||''}" alt="" style="width:100%;height:100%;object-fit:cover" onerror="this.parentElement.innerHTML='<div style=\'display:flex;align-items:center;justify-content:center;height:100%;font-size:2rem\'>üì∞</div>'">
        </div>
        <div style="padding:14px">
          <div style="display:flex;align-items:center;gap:6px;margin-bottom:8px">
            <span style="background:var(--color-accent);color:var(--color-bg);font-size:.6rem;font-weight:800;padding:2px 7px;border-radius:8px">${n.category||"Tin t·ª©c"}</span>
            <span style="font-size:.68rem;color:var(--color-text-muted);margin-left:auto">${timeAgo(n.published_at)}</span>
          </div>
          <h4 style="font-family:var(--font-display);font-weight:800;font-size:.88rem;line-height:1.3;margin:0;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden">${(n.title||"").replace(/</g,"&lt;")}</h4>
        </div>
      </article>`).join("") || `<p style="color:var(--color-text-muted);text-align:center;padding:20px;grid-column:1/-1">Ch∆∞a c√≥ tin t·ª©c.</p>`;

    if (append) grid.insertAdjacentHTML("beforeend", html);
    else grid.innerHTML = html;

    document.getElementById("news-more-btn")?.style && (document.getElementById("news-more-btn").style.display = data.pages > data.page ? "" : "none");
  }


  async function loadLive() {
    const res = await API.matches.live();
    const bar = document.getElementById("live-bar");
    if (!res.ok || !res.data.items?.length) { bar.style.display = "none"; return; }
    bar.style.display = "";
    document.getElementById("live-matches-inline").innerHTML = res.data.items.map(m =>
      `<span style="font-family:var(--font-display);font-size:.85rem;font-weight:700">
        ${UI.escapeHtml(m.home_team.name)} <span style="color:var(--color-live)">${m.home_team.score??0}‚Äì${m.away_team.score??0}</span> ${UI.escapeHtml(m.away_team.name)}
        <span style="color:var(--color-text-muted);font-size:.75rem;font-weight:400">${m.minute??""}'</span>
      </span>`).join("<span style='color:var(--color-border-strong)'>|</span>");
  }

  async function loadUpcoming() {
    const res = await API.matches.upcoming({ limit: 4 });
    if (!res.ok) return;
    document.getElementById("upcoming-list").innerHTML = (res.data.items||[]).map(m => `
      <div style="display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:8px;padding:10px 0;border-bottom:1px solid var(--color-border)">
        <div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">
          <span style="font-family:var(--font-display);font-size:.85rem;font-weight:700;text-align:right">${UI.escapeHtml(m.home_team?.name||"")}</span>
          <img src="${m.home_team?.badge||""}" width="22" height="22" style="object-fit:contain" onerror="this.style.display='none'">
        </div>
        <div style="text-align:center;font-family:var(--font-display);font-size:.75rem;color:var(--color-text-muted);white-space:nowrap">
          ${m.kickoff_at ? UI.formatDateTime(m.kickoff_at) : "TBD"}
        </div>
        <div style="display:flex;align-items:center;gap:8px">
          <img src="${m.away_team?.badge||""}" width="22" height="22" style="object-fit:contain" onerror="this.style.display='none'">
          <span style="font-family:var(--font-display);font-size:.85rem;font-weight:700">${UI.escapeHtml(m.away_team?.name||"")}</span>
        </div>
      </div>`).join("") || `<p style="color:var(--color-text-muted);font-size:.85rem;padding:12px 0">Kh√¥ng c√≥ tr·∫≠n s·∫Øp t·ªõi.</p>`;
  }

  async function loadMiniTable() {
    const res = await API.standings.list();
    if (!res.ok) return;
    const top5 = (res.data.items||[]).slice(0,5);
    document.getElementById("mini-table").innerHTML = `
      <table class="standings-table" style="font-size:.82rem">
        <thead><tr><th>#</th><th style="text-align:left">ƒê·ªôi</th><th>ƒê</th><th>BT</th><th>Tƒê</th></tr></thead>
        <tbody>${top5.map(s=>`
          <tr class="${s.status==="champions_league"?"standings-status-cl":s.status==="relegation"?"standings-status-rel":""}">
            <td class="standings-pos">${s.position}</td>
            <td><div class="standings-team">
              <img class="standings-team-badge" src="${s.team?.badge||""}" alt="" onerror="this.style.display='none'">
              <span class="standings-team-name">${UI.escapeHtml(s.team?.short||s.team?.name||"")}</span>
            </div></td>
            <td>${s.played}</td>
            <td class="standings-pts">${s.points}</td>
            <td style="color:${s.goal_difference>=0?"var(--color-win)":"var(--color-live)"}">${s.goal_difference>0?"+":""}${s.goal_difference}</td>
          </tr>`).join("")}
        </tbody>
      </table>`;
  }

  async function loadTopScorers() {
    const league = typeof Theme !== "undefined" ? Theme.getLeague() : "PL";
    const res = await fetch(`/api/statistics/players?league=${league}&sort=goals&per_page=5`);
    const resData = { ok: res.ok, data: res.ok ? await res.json() : {} };
    const res2 = { ok: resData.ok, data: resData.data };
    if (!res2.ok) return;
    document.getElementById("top-scorers").innerHTML = (res2.data.items||[]).map((s,i)=>`
      <div>
        <div style="position:relative;width:56px;height:56px;margin:0 auto 8px">
          <img src="${s.player_photo||""}" width="56" height="56" style="border-radius:50%;object-fit:cover;border:2px solid var(--color-accent)" onerror="this.src=''">
          <span style="position:absolute;bottom:-4px;right:-4px;background:var(--color-accent);color:var(--color-primary);width:20px;height:20px;border-radius:50%;font-family:var(--font-display);font-weight:900;font-size:.65rem;display:flex;align-items:center;justify-content:center">${s.goals}</span>
        </div>
        <p style="font-family:var(--font-display);font-weight:800;font-size:.78rem;line-height:1.2;text-transform:uppercase">${UI.escapeHtml((s.player_name||"").split(" ").slice(-1)[0])}</p>
        <p style="font-size:.7rem;color:var(--color-text-muted);margin-top:2px">${UI.escapeHtml(s.club_name||"")}</p>
      </div>`).join("") || `<p style="color:var(--color-text-muted);font-size:.82rem;grid-column:1/-1">Ch∆∞a c√≥ d·ªØ li·ªáu.</p>`;
  }

  document.addEventListener("DOMContentLoaded", () => {
    reload(Theme.getLeague());
    Theme.onChange(reload);

    // Category filter
    document.getElementById("news-filters")?.addEventListener("click", e => {
      const btn = e.target.closest("[data-cat]");
      if (!btn) return;
      newsCat = btn.dataset.cat;
      newsPage = 1;
      document.querySelectorAll("#news-filters button").forEach(b => { b.classList.remove("btn-primary"); b.classList.add("btn-ghost"); });
      btn.classList.add("btn-primary"); btn.classList.remove("btn-ghost");
      loadNews();
    });

    // Load more
    document.getElementById("load-more-news")?.addEventListener("click", () => {
      if (loading) return; loading=true;
      newsPage++;
      loadNews(true).finally(()=>loading=false);
    });

    // Auto-refresh live every 60s
    setInterval(loadLive, 60000);
  });

  return { reload };
})();
</script>
{% endblock %}