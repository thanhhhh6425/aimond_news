{% extends "base.html" %}
{% block title %}Bảng xếp hạng{% endblock %}
{% block content %}
<section class="section container" style="padding-top:90px">
  <h1 class="section-title">Bảng Xếp Hạng — <span id="league-label">Premier League</span></h1>

  <div id="legend-pl" style="display:flex;gap:16px;flex-wrap:wrap;margin-bottom:20px;font-size:.78rem;color:var(--color-text-muted)">
    <span><span style="display:inline-block;width:10px;height:10px;background:#1a73e8;border-radius:2px;margin-right:5px"></span>Top 4 — Champions League</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#f5a623;border-radius:2px;margin-right:5px"></span>5-6 — Europa League</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#2ecc71;border-radius:2px;margin-right:5px"></span>7 — Conference League</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#e74c3c;border-radius:2px;margin-right:5px"></span>18-20 — Xuống hạng</span>
  </div>

  <div id="legend-ucl" style="display:none;flex-wrap:wrap;gap:16px;margin-bottom:20px;font-size:.78rem;color:var(--color-text-muted)">
    <span><span style="display:inline-block;width:10px;height:10px;background:#1a73e8;border-radius:2px;margin-right:5px"></span>Top 8 — Vào thẳng Vòng 1/8</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#f5a623;border-radius:2px;margin-right:5px"></span>9-24 — Playoff Vòng 1/16</span>
    <span><span style="display:inline-block;width:10px;height:10px;background:#e74c3c;border-radius:2px;margin-right:5px"></span>25-36 — Bị loại</span>
  </div>

  <div class="card">
    <div style="overflow-x:auto">
      <table class="standings-table">
        <thead>
          <tr>
            <th style="width:40px">#</th>
            <th style="text-align:left;min-width:180px">Đội bóng</th>
            <th title="Trận đã đấu">Đ</th>
            <th title="Thắng">T</th>
            <th title="Hòa">H</th>
            <th title="Thua">B</th>
            <th title="Bàn thắng - Bàn thua">BT-BB</th>
            <th title="Hiệu số">HS</th>
            <th title="Điểm" style="color:var(--color-accent)">Điểm</th>
            <th id="th-next" title="Trận tiếp theo" style="min-width:130px;text-align:left">Đối thủ tiếp theo</th>
          </tr>
        </thead>
        <tbody id="standings-body">
          <tr><td colspan="10" style="text-align:center;padding:40px;color:var(--color-text-muted)">Đang tải...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
</section>
{% endblock %}

{% block extra_js %}
<script>
(function(){
  let currentLeague = "PL";
  // Từ điển quy đổi tên CLB thành Name Tag (Bao gồm các đội trên hình của bạn)
  const TEAM_TAGS = {
    "Arsenal": "ARS", "Aston Villa": "AVL", "AFC Bournemouth": "BOU", "Brentford": "BRE",
    "Brighton & Hove Albion": "BHA", "Chelsea": "CHE", "Crystal Palace": "CRY",
    "Everton": "EVE", "Fulham": "FUL", "Liverpool": "LIV", "Manchester City": "MCI",
    "Manchester United": "MUN", "Newcastle United": "NEW", "Nottingham Forest": "NFO",
    "Tottenham Hotspur": "TOT", "West Ham United": "WHU", "Wolverhampton Wanderers": "WOL",
    "Sunderland": "SUN", "Burnley": "BUR", "Leeds United": "LEE", "Ipswich Town": "IPS",
    "Leicester City": "LEI", "Southampton": "SOU"
  };

  // Hàm lấy Name Tag (Nếu API không có sẵn)
  function getTag(name) {
    if (!name) return "";
    if (TEAM_TAGS[name]) return TEAM_TAGS[name];
    return name.substring(0, 3).toUpperCase(); // Backup: Tự động lấy 3 chữ cái đầu viết hoa
  }

  function plColor(pos) {
    if (pos <= 4)  return "#1a73e8";
    if (pos <= 6)  return "#f5a623";
    if (pos === 7) return "#2ecc71";
    if (pos >= 18) return "#e74c3c";
    return "transparent";
  }
  function uclColor(pos) {
    if (pos <= 8)  return "#1a73e8";
    if (pos <= 24) return "#f5a623";
    return "#e74c3c";
  }

  async function load(league) {
    currentLeague = (league||"PL").toUpperCase();
    document.getElementById("league-label").textContent = currentLeague === "UCL" ? "Champions League" : "Premier League";
    document.getElementById("legend-pl").style.display  = currentLeague === "PL"  ? "flex" : "none";
    document.getElementById("legend-ucl").style.display = currentLeague === "UCL" ? "flex" : "none";
    document.getElementById("th-next").style.display    = currentLeague === "UCL" ? "none" : "";

    const tbody = document.getElementById("standings-body");
    tbody.innerHTML = Array(currentLeague==="UCL"?36:20).fill(
      '<tr><td colspan="10"><div class="skeleton" style="height:38px;margin:2px 0"></div></td></tr>'
    ).join("");

    // Fetch standings + upcoming matches dong thoi
    let standings, matches;
    try {
      const [r1, r2] = await Promise.all([
        fetch(`/api/standings/?league=${currentLeague}&season=2025`),
        fetch(`/api/matches/?league=${currentLeague}&season=2025&status=SCHEDULED&per_page=200`)
      ]);
      standings = await r1.json();
      matches   = await r2.json();
    } catch(e) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:32px;color:var(--color-text-muted)">Lỗi kết nối.</td></tr>`;
      return;
    }

    // Build next match map: team_name -> {opponentTag, badge, home}
    const now = Date.now();
    const nextMap = {};
    const upcoming = (matches.items||[])
      .filter(m => new Date(m.kickoff_at) >= now)
      .sort((a,b) => new Date(a.kickoff_at) - new Date(b.kickoff_at));

    for (const m of upcoming) {
      const ht = m.home_team || {}, at = m.away_team || {};
      const h = ht.name, a = at.name;
      const hb = ht.badge || "", ab = at.badge || "";

      // Ưu tiên dùng short_name từ API (nếu có), nếu không có thì dùng từ điển của mình
      const hTag = ht.short_name || getTag(h);
      const aTag = at.short_name || getTag(a);

      if (h && !nextMap[h]) nextMap[h] = { opponentTag: aTag, badge: ab, home: true,  kickoff: m.kickoff_at };
      if (a && !nextMap[a]) nextMap[a] = { opponentTag: hTag, badge: hb, home: false, kickoff: m.kickoff_at };
    }

    function renderNext(teamName) {
      const n = nextMap[teamName];
      if (!n) return `<span style="color:var(--color-text-muted);font-size:.78rem">—</span>`;

      const ha = n.home
        ? `<span style="background:#1a73e8;color:#fff;font-size:.6rem;font-weight:800;padding:2px 5px;border-radius:4px">H</span>`
        : `<span style="background:#e74c3c;color:#fff;font-size:.6rem;font-weight:800;padding:2px 5px;border-radius:4px">A</span>`;

      // Xử lý cả giờ và ngày, ép múi giờ +7 để không bị sai lệch
      let dateTimeStr = "";
      if (n.kickoff) {
        let str = n.kickoff.replace(" ", "T");
        if (!str.endsWith("Z") && !str.includes("+")) str += "Z";
        const d = new Date(str);

        const time = d.toLocaleTimeString("vi-VN", {hour:"2-digit", minute:"2-digit", timeZone:"Asia/Ho_Chi_Minh"});
        // Replace dấu '/' thành '-' để giữ nguyên định dạng 01-03 giống như ảnh của bạn
        const date = d.toLocaleDateString("vi-VN", {day:"2-digit", month:"2-digit", timeZone:"Asia/Ho_Chi_Minh"}).replace(/\//g, "-");

        dateTimeStr = `${time} ${date}`;
      }

      return `<div style="display:flex;align-items:center;gap:8px">
        ${n.badge ? `<img src="${n.badge}" width="18" height="18" style="object-fit:contain;flex-shrink:0" onerror="this.style.display='none'">` : ""}
        <span style="font-size:.82rem;font-weight:800;font-family:var(--font-display);width:28px;display:inline-block">${n.opponentTag}</span>
        ${ha}
        ${dateTimeStr ? `<span style="font-size:.68rem;color:var(--color-text-muted);white-space:nowrap;margin-left:auto">${dateTimeStr}</span>` : ""}
      </div>`;
    }

    const items = (standings.items||[]).sort((a,b) => a.position - b.position);
    if (!items.length) {
      tbody.innerHTML = `<tr><td colspan="10" style="text-align:center;padding:32px;color:var(--color-text-muted)">Chưa có dữ liệu.</td></tr>`;
      return;
    }

    tbody.innerHTML = items.map(s => {
      const color    = currentLeague === "UCL" ? uclColor(s.position) : plColor(s.position);
      const team     = s.team || {};
      const badge    = team.badge || "";
      const clubUrl  = team.id ? `/clubs/${team.id}` : "#";
      const teamName = team.name || s.team_name || "";
      const gd       = s.goal_difference >= 0 ? `+${s.goal_difference}` : `${s.goal_difference}`;
      const gdColor  = s.goal_difference > 0 ? "var(--color-win)" : s.goal_difference < 0 ? "var(--color-live)" : "";

      return `<tr style="border-left:3px solid ${color}">
        <td style="font-family:var(--font-display);font-weight:900;color:var(--color-text-muted)">${s.position}</td>
        <td>
          <div style="display:flex;align-items:center;gap:10px">
            <img src="${badge}" width="24" height="24" style="object-fit:contain;flex-shrink:0" onerror="this.style.opacity=0">
            <a href="${clubUrl}" style="font-family:var(--font-display);font-weight:700;font-size:.88rem;transition:color .2s"
               onmouseover="this.style.color='var(--color-accent)'" onmouseout="this.style.color=''">
              ${teamName.replace(/</g,"&lt;")}
            </a>
          </div>
        </td>
        <td>${s.played}</td>
        <td>${s.won}</td>
        <td>${s.drawn}</td>
        <td>${s.lost}</td>
        <td style="font-size:.82rem">${s.goals_for}:${s.goals_against}</td>
        <td style="color:${gdColor};font-weight:700">${gd}</td>
        <td style="font-family:var(--font-display);font-weight:900;font-size:1rem;color:var(--color-accent)">${s.points}</td>
        ${currentLeague === "PL" ? `<td>${renderNext(teamName)}</td>` : ""}
      </tr>`;
    }).join("");
  }

  document.addEventListener("DOMContentLoaded", () => {
    const lg = typeof Theme !== "undefined" ? Theme.getLeague() : "PL";
    load(lg);
    if (typeof Theme !== "undefined") Theme.onChange(load);
  });
})();
</script>
{% endblock %}